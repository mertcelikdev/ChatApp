@{
    ViewData["Title"] = "GiriÅŸ Yap";
    Layout = "_Layout";
}

<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card mt-5">
            <div class="card-header bg-primary text-white text-center">
                <h3><i class="fas fa-sign-in-alt"></i> ChatApp'e GiriÅŸ Yap</h3>
            </div>
            <div class="card-body">
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">
                            <i class="fas fa-user"></i> KullanÄ±cÄ± AdÄ±:
                        </label>
                        <input type="text" class="form-control" id="username" placeholder="KullanÄ±cÄ± adÄ±nÄ±zÄ± girin" required maxlength="20">
                        <div class="form-text">En fazla 20 karakter olmalÄ±dÄ±r</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="password" class="form-label">
                            <i class="fas fa-lock"></i> Åifre:
                        </label>
                        <input type="password" class="form-control" id="password" placeholder="Åifrenizi girin" required minlength="6">
                        <div class="form-text">En az 6 karakter olmalÄ±dÄ±r</div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="loginButton">
                            <i class="fas fa-sign-in-alt"></i> GiriÅŸ Yap
                        </button>
                    </div>
                </form>

                <div id="loginStatus" class="mt-3"></div>

                <div class="text-center mt-4">
                    <hr>
                    <p class="mb-2">HesabÄ±nÄ±z yok mu?</p>
                    <a href="/User/Register" class="btn btn-outline-success">
                        <i class="fas fa-user-plus"></i> KayÄ±t Ol
                    </a>
                </div>

                <!-- Online Users -->
                <div class="mt-4">
                    <h6><i class="fas fa-users text-success"></i> Aktif KullanÄ±cÄ±lar (<span id="onlineCount">0</span>)</h6>
                    <div id="onlineUsers" class="small text-muted">
                        <em>YÃ¼kleniyor...</em>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info Card -->
        <div class="card mt-3">
            <div class="card-body">
                <h6><i class="fas fa-info-circle text-info"></i> Test KullanÄ±cÄ±larÄ±</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>KullanÄ±cÄ± AdÄ±</th>
                                <th>Åifre</th>
                                <th>Avatar</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>admin</code></td>
                                <td><code>123456</code></td>
                                <td>ğŸ‘‘</td>
                            </tr>
                            <tr>
                                <td><code>user1</code></td>
                                <td><code>user123</code></td>
                                <td>ğŸ˜Š</td>
                            </tr>
                            <tr>
                                <td><code>test</code></td>
                                <td><code>test123</code></td>
                                <td>ğŸ§ª</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <hr>
                
                <h6><i class="fas fa-rocket text-primary"></i> ChatApp Ã–zellikleri</h6>
                <div class="row">
                    <div class="col-6">
                        <small><i class="fas fa-user-friends text-primary"></i> Ã–zel MesajlaÅŸma</small>
                    </div>
                    <div class="col-6">
                        <small><i class="fas fa-users text-success"></i> Genel Sohbet</small>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-6">
                        <small><i class="fas fa-bolt text-warning"></i> AnlÄ±k Ä°letiÅŸim</small>
                    </div>
                    <div class="col-6">
                        <small><i class="fas fa-database text-info"></i> PostgreSQL</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
// KullanÄ±cÄ± zaten giriÅŸ yapmÄ±ÅŸsa chat sayfasÄ±na yÃ¶nlendir
window.addEventListener('DOMContentLoaded', function() {
    const savedUsername = localStorage.getItem('chatapp_username');
    const loginTime = localStorage.getItem('chatapp_login_time');
    
    if (savedUsername && loginTime) {
        // GiriÅŸ zamanÄ±nÄ± kontrol et (24 saat geÃ§erliliÄŸi)
        const loginDate = new Date(loginTime);
        const now = new Date();
        const hoursDiff = (now - loginDate) / (1000 * 60 * 60);
        
        if (hoursDiff < 24) {
            console.log(`KullanÄ±cÄ± ${savedUsername} zaten giriÅŸ yapmÄ±ÅŸ. Chat sayfasÄ±na yÃ¶nlendiriliyor...`);
            showStatus(`HoÅŸ geldin ${savedUsername}! Chat sayfasÄ±na yÃ¶nlendiriliyorsun...`, 'success');
            setTimeout(() => {
                window.location.href = '/Chat';
            }, 1000);
            return;
        } else {
            // Eski oturum sÃ¼resi dolmuÅŸ, temizle
            localStorage.removeItem('chatapp_username');
            localStorage.removeItem('chatapp_login_time');
        }
    }
});

// SignalR Connection
const connection = new signalR.HubConnectionBuilder()
    .withUrl("/chathub")
    .build();

let currentConnectionId = '';

// Connection durumu
connection.start().then(function () {
    currentConnectionId = connection.connectionId;
    console.log('ğŸ”— SignalR Connected for login');
    loadOnlineUsers();
}).catch(function (err) {
    console.error('âŒ SignalR Connection Error:', err);
    showStatus('BaÄŸlantÄ± hatasÄ±. Sayfa yenilenerek deneyin.', 'danger');
});

// Login form
document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    
    if (!username) {
        showStatus('KullanÄ±cÄ± adÄ± boÅŸ olamaz', 'warning');
        return;
    }

    if (!password) {
        showStatus('Åifre boÅŸ olamaz', 'warning');
        return;
    }

    if (username.length < 3) {
        showStatus('KullanÄ±cÄ± adÄ± en az 3 karakter olmalÄ±dÄ±r', 'warning');
        return;
    }

    if (password.length < 6) {
        showStatus('Åifre en az 6 karakter olmalÄ±dÄ±r', 'warning');
        return;
    }

    if (username.length > 20) {
        showStatus('KullanÄ±cÄ± adÄ± en fazla 20 karakter olabilir', 'warning');
        return;
    }

    const loginButton = document.getElementById('loginButton');
    loginButton.disabled = true;
    loginButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> GiriÅŸ yapÄ±lÄ±yor...';

    try {
        const response = await fetch('/api/userapi/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                username: username,
                password: password,
                connectionId: currentConnectionId
            })
        });

        const result = await response.json();

        if (result.success) {
            showStatus(`âœ… HoÅŸ geldin ${username}!`, 'success');
            
            // KullanÄ±cÄ± adÄ±nÄ± localStorage'a kaydet
            localStorage.setItem('chatapp_username', username);
            localStorage.setItem('chatapp_login_time', new Date().toISOString());
            
            // Ana sayfaya yÃ¶nlendir
            setTimeout(() => {
                window.location.href = '/Chat';
            }, 1500);
        } else {
            showStatus(`âŒ ${result.message}`, 'danger');
        }
    } catch (error) {
        showStatus('âŒ GiriÅŸ yapÄ±lÄ±rken hata oluÅŸtu', 'danger');
        console.error('Login error:', error);
    } finally {
        loginButton.disabled = false;
        loginButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> GiriÅŸ Yap';
    }
});

// Online kullanÄ±cÄ±larÄ± yÃ¼kle
async function loadOnlineUsers() {
    try {
        const response = await fetch('/api/userapi/online');
        const result = await response.json();
        
        if (result.success) {
            updateOnlineUsers(result.users);
        }
    } catch (error) {
        console.error('Error loading online users:', error);
        document.getElementById('onlineUsers').innerHTML = '<em class="text-danger">YÃ¼klenemedi</em>';
    }
}

function updateOnlineUsers(users) {
    const onlineCount = document.getElementById('onlineCount');
    const onlineUsers = document.getElementById('onlineUsers');
    
    onlineCount.textContent = users.length;
    
    if (users.length === 0) {
        onlineUsers.innerHTML = '<em>HenÃ¼z kimse online deÄŸil</em>';
    } else {
        const userList = users.map(user => {
            const loginTime = new Date(user.loginTime).toLocaleTimeString();
            return `<span class="badge bg-success me-1">${user.username}</span>`;
        }).join('');
        onlineUsers.innerHTML = userList;
    }
}

function showStatus(message, type = 'info') {
    const statusDiv = document.getElementById('loginStatus');
    statusDiv.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
}

// SignalR events for real-time user updates
connection.on('UserJoined', function(data) {
    console.log('ğŸ‘¤ User joined:', data);
    loadOnlineUsers(); // Refresh online users
    
    if (data.username) {
        showStatus(`ğŸŸ¢ ${data.username} katÄ±ldÄ±`, 'info');
    }
});

connection.on('UserLeft', function(data) {
    console.log('ğŸ‘¤ User left:', data);
    loadOnlineUsers(); // Refresh online users
    
    if (data.username) {
        showStatus(`ğŸ”´ ${data.username} ayrÄ±ldÄ±`, 'warning');
    }
});

// Check if user is already logged in
document.addEventListener('DOMContentLoaded', function() {
    const savedUsername = localStorage.getItem('chatapp_username');
    if (savedUsername) {
        document.getElementById('username').value = savedUsername;
        showStatus(`Son giriÅŸ: ${savedUsername}`, 'info');
    }
});

</script>
}
